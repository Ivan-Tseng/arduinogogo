<!DOCTYPE html>
<html lang="en">
<body>
  <h1>ESP32 Motor & EMG Control</h1>
  <button id="connectButton">Connect to ESP32</button>
  <button id="motorForwardButton" disabled>Motor Forward</button>
  <button id="motorReverseButton" disabled>Motor Reverse</button>
  <div id="status">Status: Not Connected</div>
  <div id="emgDisplay">EMG: -</div>

  <script>
    let motorCharacteristic, emgCharacteristic;

    async function connectToESP32() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
        
        motorCharacteristic = await service.getCharacteristic('c0de1234-5678-9101-1121-314151617181');
        emgCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
        
        await emgCharacteristic.startNotifications();
        emgCharacteristic.addEventListener('characteristicvaluechanged', handleEMGUpdate);

        document.getElementById('status').innerText = "Status: Connected";
        document.getElementById('motorForwardButton').disabled = false;
        document.getElementById('motorReverseButton').disabled = false;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('status').innerText = "Status: Connection Failed";
      }
    }

    function handleEMGUpdate(event) {
      const decoder = new TextDecoder();
      const emgValue = decoder.decode(event.target.value);
      document.getElementById('emgDisplay').innerText = `EMG: ${emgValue}`;
    }

    // 控制馬達函數
    async function motorForward() {
      if (!motorCharacteristic) return;
      const encoder = new TextEncoder();
      await motorCharacteristic.writeValue(encoder.encode("forward"));
    }

    async function motorReverse() {
      if (!motorCharacteristic) return;
      const encoder = new TextEncoder();
      await motorCharacteristic.writeValue(encoder.encode("backward"));
    }

    // 綁定按鈕事件
    document.getElementById('connectButton').addEventListener('click', connectToESP32);
    document.getElementById('motorForwardButton').addEventListener('click', motorForward);
    document.getElementById('motorReverseButton').addEventListener('click', motorReverse);
  </script>
</body>
</html>
