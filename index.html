<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE 控制與 EMG 監測</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ESP32 BLE 馬達控制與 EMG 數據</h1>
    <button onclick="connectBLE()">🔗 連接 ESP32</button>
    <button onclick="sendCommand('forward')">🚀 前進</button>
    <button onclick="sendCommand('backward')">🔄 後退</button>
    <button onclick="sendReset()">🔄 重新開始 EMG</button>
    <button onclick="downloadCSV()">💾 下載數據</button>
    <p id="status">未連接</p>
    
    <canvas id="emgChart" width="400" height="200"></canvas>
    
    <script>
        let bleDevice;
        let motorCharacteristic;
        let resetCharacteristic;
        let emgCharacteristic;
        let emgData = [];
        let labels = [];
        let chart;
        let isConnected = false;

        async function connectBLE() {
            try {
                if (isConnected) {
                    console.log("已連接 ESP32");
                    return;
                }

                bleDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });

                const server = await bleDevice.gatt.connect();
                isConnected = true;
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                motorCharacteristic = await service.getCharacteristic('c0de1234-5678-9101-1121-314151617181');
                resetCharacteristic = await service.getCharacteristic('d1e2f3a4-5678-9101-1121-314151617182');
                emgCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');

                // 監聽 EMG 數據
                emgCharacteristic.startNotifications();
                emgCharacteristic.addEventListener('characteristicvaluechanged', handleEMGData);

                document.getElementById("status").innerText = "✅ 已連接";
                setupChart();

                // BLE 斷開時自動重連
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
            } catch (error) {
                console.error(error);
                document.getElementById("status").innerText = "❌ 連接失敗";
                isConnected = false;
            }
        }

        function onDisconnected() {
            console.log("BLE 斷開，嘗試重新連接...");
            isConnected = false;
            document.getElementById("status").innerText = "🔴 連線中斷";
            setTimeout(connectBLE, 3000); // 3秒後自動重連
        }

        async function sendCommand(command) {
            if (motorCharacteristic) {
                let encoder = new TextEncoder();
                await motorCharacteristic.writeValue(encoder.encode(command));
                console.log(`Sent: ${command}`);

                // 等待馬達指令執行後，確保 EMG 數據繼續傳輸
                setTimeout(() => {
                    if (emgCharacteristic) {
                        emgCharacteristic.startNotifications();
                        console.log("🔄 重新開始 EMG 數據接收");
                    }
                }, 1500);
            }
        }
        
        async function sendReset() {
            if (resetCharacteristic) {
                let encoder = new TextEncoder();
                await resetCharacteristic.writeValue(encoder.encode("reset"));
                console.log("EMG 重新開始");
                
                // 清除數據並更新圖表
                emgData = [];
                labels = [];
                chart.update();
            }
        }

        function handleEMGData(event) {
            let value = new TextDecoder().decode(event.target.value);
            let emgValue = parseInt(value);
            if (!isNaN(emgValue)) {
                if (emgData.length > 50) {
                    emgData.shift();
                    labels.shift();
                }
                emgData.push(emgValue);
                labels.push(new Date().toLocaleTimeString());

                // 只在一定間隔內更新圖表，避免過度渲染
                if (emgData.length % 5 === 0) {
                    chart.update();
                }
            }
        }

        function setupChart() {
            let ctx = document.getElementById('emgChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'EMG 數據',
                        data: emgData,
                        borderColor: 'blue',
                        borderWidth: 1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { display: true },
                        y: { display: true }
                    }
                }
            });
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Time,EMG Value\n";
            for (let i = 0; i < emgData.length; i++) {
                csvContent += labels[i] + "," + emgData[i] + "\n";
            }
            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "emg_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
